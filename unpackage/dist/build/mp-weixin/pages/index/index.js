"use strict";var e=require("../../common/vendor.js");if(!Array){(e.resolveComponent("uni-icons")+e.resolveComponent("uni-popup-dialog")+e.resolveComponent("uni-popup"))()}Math||((()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js")+(()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js"))();const a={__name:"index",setup(a){const n=e.ref(""),o=e.ref([]),t=e.ref(e.dayjs().format("YYYY-MM-DD HH:mm:ss")),i=e.ref(0);e.ref();const l=e.ref(),u=e.ref(),s=e.ref(),r=e.ref(),c=e.ref();e.ref();const p=e.ref(),d=e.ref(0),v=e.ref("用户你好，为了让您更好的体验此小程序。在使用之前请您仔细阅读以下几点要求："),m=()=>{h(),k(),l.value=!1},g=()=>{console.log("关闭"),l.value=!1},f=a=>{e.pn.callFunction({name:"happy",data:{api:a||"getMessage",token:e.index.getStorageSync("token")}}).then((e=>{o.value=e.result.data}))},h=async()=>{await e.index.getUserProfile({desc:"用于完善用户信息",success:e=>{s.value=e.userInfo.avatarUrl,u.value=e.userInfo.nickName,r.value=e.userInfo.signature},fail:e=>{console.log(e)}})},k=async()=>{await e.index.login({timeout:1e4,success:e=>{c.value=e.code,console.log(e.code)},fail:e=>{console.log(e)}})},y=async()=>{const e=o.value.length;p.value="id-"+(e-1)};e.onLoad((()=>{k(),f()}));return(a,k)=>({a:e.f(o.value,((a,n,t)=>({a:a.avatarUrl,b:e.t(a.nickName),c:e.t(a.message),d:e.t(a.createTime),e:"1e0064b8-0-"+t,f:e.t(a.likeNumber),g:e.o((n=>(async(a,n,t)=>{n++,await e.pn.callFunction({name:"happy",data:{api:"updatelikes",likeNumber:n,id:a,token:e.index.getStorageSync("token")}}).then((n=>{e.index.showToast({title:"点赞成功",icon:"success"}),o.value.filter((e=>e._id==a))[0].likeNumber++})).catch((a=>{e.index.showToast({title:"你已经点过赞啦",icon:"error"})}))})(a._id,a.likeNumber))),h:a._id,i:"id-"+n}))),b:e.p({type:"hand-up-filled",size:"14"}),c:p.value,d:e.o((a=>(()=>{let a=e.index.getStorageSync("token");a?f():s.value&&u.value?e.pn.callFunction({name:"happy",data:{api:"loginWithMp",nickName:u.value,avatarUrl:s.value,signature:r.value,code:c.value}}).then((({result:n})=>{a=n.token,e.index.setStorageSync("token",a),f()})):h()})())),e:n.value,f:e.o((e=>n.value=e.detail.value)),g:e.o((a=>(async()=>{if(!n.value)throw e.index.showToast({title:"留言不能为空",icon:"error"}),new Error("不能为空");await e.pn.callFunction({name:"happy",data:{api:"message",message:n.value,likeNum:i.value,createTime:t.value,nickName:u.value,avatarUrl:s.value,status:d.value,token:e.index.getStorageSync("token")}}).then((a=>{f(),y(),n.value="",e.index.showToast({title:"留言成功",icon:"success"})}))})())),h:e.o(m),i:e.o(g),j:e.p({type:"info",cancelText:"不同意",confirmText:"我同意",title:"用户协议",content:v.value}),k:e.sr("alertDialog","1e0064b8-1"),l:e.p({type:"dialog"}),m:l.value})}};wx.createPage(a);
