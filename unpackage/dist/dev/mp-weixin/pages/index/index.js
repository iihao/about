"use strict";var e=require("../../common/vendor.js");Array||e.resolveComponent("uni-icons")();const S=()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js";Math||S();const L={__name:"index",setup(f){const t=e.ref(""),l=e.ref([]),h=e.ref(e.dayjs().format("YYYY-MM-DD HH:mm:ss")),x=e.ref(0);e.ref();const u=e.ref(),c=e.ref([]),k=e.pn.database(),g=e.ref();e.ref();const _=e.ref(),y=e.ref(0),r=e.ref({}),w=async()=>{if(t.value)await e.pn.callFunction({name:"happy",data:{api:"message",message:t.value,likeNum:x.value,createTime:h.value,nickName:c.value.nickName,avatarUrl:c.value.avatarUrl,status:y.value,token:e.index.getStorageSync("token")}}).then(o=>{i(),t.value="",e.index.showToast({title:"\u7559\u8A00\u6210\u529F",icon:"success"}),e.index.pageScrollTo({scrollTop:0,selector:".app-main",duration:400})}).catch(o=>{console.log(o),e.index.showToast({title:"\u7559\u8A00\u5931\u8D25",icon:"error"})});else throw e.index.showToast({title:"\u7559\u8A00\u4E0D\u80FD\u4E3A\u7A7A",icon:"error"}),new Error("\u4E0D\u80FD\u4E3A\u7A7A")},i=o=>{e.pn.callFunction({name:"happy",data:{api:o||"getMessage",token:e.index.getStorageSync("token")}}).then(a=>{e.index.hideLoading(),console.log(a),l.value=a.result.data}).catch(a=>{console.log(a),e.index.showToast({title:"\u83B7\u53D6\u7559\u8A00\u5931\u8D25",icon:"error"})})},b=async(o,a,n)=>{a++,await e.pn.callFunction({name:"happy",data:{api:"updatelikes",likeNumber:a,id:o,token:e.index.getStorageSync("token")}}).then(s=>{e.index.showToast({title:"\u70B9\u8D5E\u6210\u529F",icon:"success"}),u.value="red";const d=l.value.filter(v=>v._id==o);d[0].likeNumber++,console.log(s)}).catch(s=>{console.log(s),e.index.showToast({title:"\u4F60\u5DF2\u7ECF\u70B9\u8FC7\u8D5E\u5566",icon:"error"})})},p=async()=>{await e.index.login({timeout:1e4,success:o=>{g.value=o.code,console.log(o.code)},fail:o=>{console.log(o)}})},m=async()=>{await p();let o=e.index.getStorageSync("token");o?i():e.pn.callFunction({name:"happy",data:{api:"loginWithMp",nickName:c.value.nickName||"\u533F\u540D\u7528\u6237",avatarUrl:c.value.avatarUrl||"https://vkceyugu.cdn.bspapp.com/VKCEYUGU-f7df76d0-0735-45ba-bd49-e366b3796e28/e89dbb99-fcd8-4182-ad73-82395d85bb9f.png",code:g.value}}).then(({result:a})=>{o=a.token,console.log(a),e.index.setStorageSync("token",o),i()}).catch(a=>{e.index.hideLoading(),console.log(a),e.index.showToast({title:"\u767B\u5F55\u5931\u8D25",icon:"error"})})},T=()=>{e.index.getStorageSync("token")?(e.index.showLoading({title:"\u52A0\u8F7D\u4E2D"}),i()):e.index.showModal({title:r.value.title||"\u7528\u6237\u534F\u8BAE",content:r.value.content||"content",confirmText:"\u540C\u610F",cancelText:"\u9000\u51FA",success:function(o){o.confirm?(e.index.showLoading({title:"\u52A0\u8F7D\u4E2D"}),m()):o.cancel&&console.log("\u7528\u6237\u70B9\u51FB\u53D6\u6D88")}})};return e.onLoad(()=>{k.collection("show-agreement").limit(1).get().then(o=>{r.value=o.result.data[0],T()}),p(),console.log("onLoad")}),e.onReady(()=>{console.log("onReady")}),(o,a)=>({a:e.f(l.value,(n,s,d)=>e.e({a:n.userId[0].avatarUrl,b:e.t(n.userId[0].nickName),c:n.status==0},n.status==0?{}:{},{d:e.t(n.message),e:e.t(n.createTime),f:"1e0064b8-0-"+d,g:e.t(n.likeNumber),h:e.o(v=>b(n._id,n.likeNumber)),i:n._id,j:"id-"+s})),b:e.p({type:"hand-up-filled",size:"14",color:u.value}),c:_.value,d:e.o(n=>m()),e:t.value,f:e.o(n=>t.value=n.detail.value),g:e.o(n=>w())})}};var M=e._export_sfc(L,[["__file","/Users/huangqiang/Documents/HBuilderProjects/iihao/pages/index/index.vue"]]);wx.createPage(M);
