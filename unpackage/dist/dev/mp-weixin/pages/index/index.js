"use strict";var e=require("../../common/vendor.js");Array||e.resolveComponent("uni-icons")();const S=()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js";Math||S();const b={__name:"index",setup(m){const t=e.ref(""),s=e.ref([]),h=e.ref(e.dayjs().format("YYYY-MM-DD HH:mm:ss")),p=e.ref(0);e.ref();const i=e.ref(),c=e.ref(),d=e.ref(),g=e.ref();e.ref();const v=e.ref(),_=e.ref(0),x=async()=>{if(t.value)await e.pn.callFunction({name:"happy",data:{api:"message",message:t.value,likeNum:p.value,createTime:h.value,nickName:i.value,avatarUrl:c.value,status:_.value,token:e.index.getStorageSync("token")}}).then(n=>{r(),w(),t.value="",e.index.showToast({title:"\u7559\u8A00\u6210\u529F",icon:"success"})}).catch(n=>{console.log(n),e.index.showToast({title:"\u7559\u8A00\u5931\u8D25",icon:"error"})});else throw e.index.showToast({title:"\u7559\u8A00\u4E0D\u80FD\u4E3A\u7A7A",icon:"error"}),new Error("\u4E0D\u80FD\u4E3A\u7A7A")},r=n=>{e.pn.callFunction({name:"happy",data:{api:n||"getMessage",token:e.index.getStorageSync("token")}}).then(o=>{s.value=o.result.data}).catch(o=>{console.log(o),e.index.showToast({title:"\u67E5\u770B\u7559\u8A00\u5931\u8D25",icon:"error"})})},k=async()=>{await e.index.getUserProfile({desc:"\u7528\u4E8E\u5B8C\u5584\u7528\u6237\u4FE1\u606F",success:n=>{c.value=n.userInfo.avatarUrl,i.value=n.userInfo.nickName,d.value=n.userInfo.signature},fail:n=>{console.log(n)}})},y=async()=>{await e.index.login({timeout:1e4,success:n=>{g.value=n.code,console.log(n.code)},fail:n=>{console.log(n)}})},w=async()=>{const n=s.value.length;v.value="id-"+(n-1)},T=async(n,o,a)=>{o++,await e.pn.callFunction({name:"happy",data:{api:"updatelikes",likeNumber:o,id:n,token:e.index.getStorageSync("token")}}).then(l=>{e.index.showToast({title:"\u70B9\u8D5E\u6210\u529F",icon:"success"});const u=s.value.filter(f=>f._id==n);u[0].likeNumber++}).catch(l=>{e.index.showToast({title:"\u4F60\u5DF2\u7ECF\u70B9\u8FC7\u8D5E\u5566",icon:"error"})})},N=()=>{let n=e.index.getStorageSync("token");if(!n){if(!c.value||!i.value)throw e.index.showToast({title:"\u672A\u767B\u5F55\u4E0D\u80FD\u7559\u8A00",icon:"error"}),k(),new Error("\u672A\u767B\u5F55\u4E0D\u80FD\u7559\u8A00");e.pn.callFunction({name:"happy",data:{api:"loginWithMp",nickName:i.value,avatarUrl:c.value,signature:d.value,code:g.value}}).then(({result:o})=>{n=o.token,e.index.setStorageSync("token",n),r()}).catch(o=>{e.index.showToast({title:"\u767B\u5F55\u5931\u8D25",icon:"error"})})}};return e.onLoad(()=>{r(),y()}),(n,o)=>({a:e.f(s.value,(a,l,u)=>({a:a.avatarUrl,b:e.t(a.nickName),c:e.t(a.message),d:e.t(a.createTime),e:"1e0064b8-0-"+u,f:e.t(a.likeNumber),g:e.o(f=>T(a._id,a.likeNumber)),h:a._id,i:"id-"+l})),b:e.p({type:"hand-up-filled",size:"14"}),c:v.value,d:e.o(a=>N()),e:t.value,f:e.o(a=>t.value=a.detail.value),g:e.o(a=>x())})}};var U=e._export_sfc(b,[["__file","/Users/huangqiang/Documents/HBuilderProjects/iihao/pages/index/index.vue"]]);wx.createPage(U);
